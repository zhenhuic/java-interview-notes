[toc]

# 分布式

## 分布式事务

CAP

BASE，Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)。

## 分布式事务解决方案

### 2PC (Two-Phase Commit)

第一阶段Prepare：事务管理器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是否可以提交。

第二阶段Commit：事务协调器要求每个数据库提交数据，或者回滚数据。

XA协议比较简单，成本较低，但是其单点问题，以及不能支持高并发(由于同步阻塞)依然是其最大的弱点。

### 3PC (Three-Phase Commit)

3PC 分为三个阶段：CanCommit，PreCommit 和 doCommit。

### TCC

Try阶段：尝试执行，完成所有业务检查（一致性），预留必须业务资源（准隔离性）。

Confirm阶段：确认执行真正执行业务，不作任何业务检查，只使用Try阶段预留的业务资源，Confirm操作满足幂等性。要求具备幂等设计，Confirm失败后需要进行重试。

Cancel阶段：取消执行，释放Try阶段预留的业务资源Cancel操作满足幂等性Cancel阶段的异常和Confirm阶段异常处理方案基本上一致。

## 服务限流算法

### 计数器算法

限制一秒钟的能够通过的请求数，比如限流qps为100，算法的实现思路就是从第一个请求进来开始计时，在接下去的1s内，每来一个请求，就把计数加1，如果累加的数字达到了100，那么后续的请求就会被全部拒绝。等到1s结束后，把计数恢复成0，重新开始计数。

### 漏桶算法

算法内部有一个容器，类似生活用到的漏斗，当请求进来时，相当于水倒入漏斗，然后从下端小口慢慢匀速的流出。不管上面流量多大，下面流出的速度始终保持不变。

在算法实现方面，可以准备一个队列，用来保存请求，另外通过一个线程池定期从队列中获取请求并执行，可以一次性获取多个并发执行。

### 令牌桶算法

算法中存在一种机制，以一定的速率往桶中放令牌。每次请求调用需要先获取令牌，只有拿到令牌，才有机会继续执行，否则选择选择等待可用的令牌、或者直接拒绝。

实现思路：可以准备一个队列，用来保存令牌，另外通过一个线程池定期生成令牌放到队列中，每来一个请求，就从队列中获取一个令牌，并继续执行。

## 分布式系统如何优化

缓存、异步队列、集群、限流、服务降级、熔断。
