## MySQL 索引原理

### 索引的类型

#### B+ Tree 索引

![](../assets/b+tree.jpg)

##### B+ 树的查找过程

如图所示，如果要查找数据项29，那么首先会把磁盘块1由磁盘加载到内存，此时发生一次IO，在内存中用二分查找确定29在17和35之间，锁定磁盘块1的P2指针，内存时间因为非常短（相比磁盘的IO）可以忽略不计，通过磁盘块1的P2指针的磁盘地址把磁盘块3由磁盘加载到内存，发生第二次IO，29在26和30之间，锁定磁盘块3的P2指针，通过指针加载磁盘块8到内存，发生第三次IO，同时内存中做二分查找找到29，结束查询，总计三次IO。真实的情况是，3层的b+树可以表示上百万的数据，如果上百万的数据查找只需要三次IO，性能提高将是巨大的，如果没有索引，每个数据项都要发生一次IO，那么总共需要百万次的IO，显然成本非常非常高。

##### B+ 树性质

1. 通过上面的分析，我们知道IO次数取决于b+数的高度h，假设当前数据表的数据为N，每个磁盘块的数据项的数量是m，则有 `h=log(m+1)N`，当数据量N一定的情况下，m越大，h越小；而m = 磁盘块的大小 / 数据项的大小，磁盘块的大小也就是一个数据页的大小，是固定的，如果数据项占的空间越小，数据项的数量越多，树的高度越低。这就是为什么每个数据项，即索引字段要尽量的小，比如 int 占4字节，要比 bigint8 字节少一半。这也是为什么b+树要求把真实的数据放到叶子节点而不是内层节点，一旦放到内层节点，磁盘块的数据项会大幅度下降，导致树增高。当数据项等于1时将会退化成线性表。
2. 当b+树的数据项是复合的数据结构，比如(name,age,sex)的时候，b+数是按照从左到右的顺序来建立搜索树的，比如当(张三,20,F)这样的数据来检索的时候，b+树会优先比较name来确定下一步的所搜方向，如果name相同再依次比较age和sex，最后得到检索的数据；但当(20,F)这样的没有name的数据来的时候，b+树就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询。比如当(张三,F)这样的数据来检索时，b+树可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据了， 这个是非常重要的性质，即索引的最左匹配特性。
3. InnoDB B+ 树索引中，主键值也被添加到二级索引的内节点记录，这样就能保证`B+`树每一层节点中各条目录项记录除`页号`这个字段外是唯一的。

##### 可以使用 B+ 树索引的查询类型

1. 全值匹配

2. 匹配最左前缀

3. 匹配列前缀，只匹配某一列的值得开头部分。

4. 匹配范围值

5. 精确匹配某一列并范围匹配另外一列

6. 只访问索引的查询（覆盖索引）

##### 建索引的几大原则

1. 最左前缀匹配原则，MySQL 会一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配。
2. =和in可以乱序，比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，MySQL 的查询优化器会帮你优化成索引可以识别的形式。
3. 尽量选择区分度高的列作为索引，区分度的公式是`count(distinct col)/count(*)`，表示字段不重复的比例。但也不是绝对的，这里高性能MySQL里有些案例。
4. 索引列不能参与计算，保持列“干净”，比如`from_unixtime(create_time) = '2014-05-29'`，`select actor_id from sakila.actor_id where actor_id + 1 = 5`就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成`create_time = unix_timestamp('2014-05-29')`，`select actor_id from sakila.actor_id where actor_id = 4`。
5. 尽量的扩展索引，不要新建索引。比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。修改一个索引之后，有可能提高了某个查询的效率，降低了另一个查询的效率，详见高性能MySQL。
6. 如果需要索引很长的字符列，（1）可以采用模拟哈希索引策略，使用 CRC32 做哈希，但是需要维护哈希值（插入和更新时维护哈希值列），可以手动维护，也可以使用触发器实现；（2）也可以索引开始的部分字符，从而提高索引效率，但这样也会降低索引选择性。可以通过计算各个长度的字符选择率来选出合适的长度。

##### 聚簇索引

聚簇索引是一种数据存储的方式，InnoDB 的聚簇索引实际上是在同一个结构中保存了 **B+ 树索引**和**数据行**。当表有聚簇索引时，它的数据行实际上存放在索引的叶子页中。“聚簇”表示数据行和相邻的键值紧凑的存储在一起，一个表只有一个聚簇索引，一般是主键。二级索引叶子节点保存的不是指向行的物理位置的指针，而是行的主键值。

###### 聚簇索引的优缺点

高性能MySQL P170

##### 覆盖索引



##### 索引合并

1. #### Intersection 合并

2. #### Union 合并

3. #### Sort-Union 合并

4. #### 联合索引替代Intersection索引合并

#### 哈希索引

#### 全文索引

#### 空间数据索引（R-Tree）

## 查询性能优化

